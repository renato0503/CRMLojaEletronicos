<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM Simplificado Eletr√¥nicos</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>" />

  <!-- CSS libs -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/Toastify.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/5.5.2/css/tabulator.min.css">

  <style>
    :root {
      --font-family: 'Inter', sans-serif;
      --primary-color: #007bff; --primary-color-rgb: 0, 123, 255;
      --secondary-color: #6c757d; --secondary-color-rgb: 108, 121, 129;
      --accent-color: #ffc107; --accent-color-rgb: 255, 193, 7;
      --background-light: #f8f9fa; --surface-light: #ffffff;
      --text-light: #212529; --text-muted-light: #6c757d;
      --border-color-light: #dee2e6;
      --danger-color: #dc3545; --danger-color-rgb: 220, 53, 69;
      --success-color: #28a745; --success-color-rgb: 40, 167, 69;
      --warning-color: #ffc107; --warning-color-rgb: 255, 193, 7;
      --background-dark: #121212; --surface-dark: #1e1e1e;
      --text-dark: #e0e0e0; --text-muted-dark: #aaaaaa;
      --border-color-dark: #444444;
      --primary-color-dark: #bb86fc; --primary-color-dark-rgb: 187, 134, 252;
      --default-padding: 15px; --default-margin: 15px; --border-radius: 5px;
      color-scheme: light dark;
    }
    body.dark-mode {
      --primary-color: var(--primary-color-dark); --primary-color-rgb: var(--primary-color-dark-rgb);
      --background-light: var(--background-dark); --surface-light: var(--surface-dark);
      --text-light: var(--text-dark); --text-muted-light: var(--text-muted-dark);
      --border-color-light: var(--border-color-dark);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family); }
    body { display: flex; min-height: 100vh; background-color: var(--background-light); color: var(--text-light); transition: background-color .3s, color .3s; overflow: hidden; font-size: 14px; }
    .hidden { display: none !important; }
    #app-container { display: flex; width: 100%; height: 100vh; overflow: hidden; }
    #sidebar { width: 220px; background: var(--surface-light); border-right: 1px solid var(--border-color-light); padding: var(--default-padding); display: flex; flex-direction: column; overflow-y: auto; }
    #sidebar .logo { font-size: 1.6em; font-weight: 700; color: var(--primary-color); text-align: center; margin-bottom: var(--default-margin); padding-bottom: var(--default-padding); border-bottom: 1px solid var(--border-color-light); }
    #sidebar nav ul { list-style: none; }
    #sidebar nav li { margin-bottom: 10px; }
    #sidebar nav a { text-decoration: none; color: var(--text-muted-light); display: flex; align-items: center; padding: 10px 15px; border-radius: var(--border-radius); transition: all .2s; font-weight: 500; }
    #sidebar nav a:hover, #sidebar nav a.active { background: rgba(var(--primary-color-rgb), .1); color: var(--primary-color); transform: translateX(5px); }
    #sidebar nav i { margin-right: 15px; width: 20px; text-align: center; }
    #main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 30px; }
    #header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color-light); }
    #header h1 { font-size: 2em; color: var(--primary-color); }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: var(--surface-light); border: 1px solid var(--border-color-light); border-radius: var(--border-radius); gap: 10px; flex-wrap: wrap; }
    .controls-bar input, .controls-bar select { padding: 8px 12px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius); background: var(--surface-light); color: var(--text-light); min-width: 150px; }
    .controls-bar button { padding: 8px 15px; border: 1px solid var(--border-color-light); background: var(--surface-light); color: var(--primary-color); border-radius: var(--border-radius); cursor: pointer; transition: all .2s; font-weight: 500; }
    .controls-bar button:hover { background: rgba(var(--primary-color-rgb), .08); }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .metric-card { background: var(--surface-light); padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color-light); text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
    .metric-label { font-size: .9em; color: var(--text-muted-light); margin-bottom: 5px; }
    .metric-value { font-size: 1.6em; font-weight: 700; color: var(--primary-color); }
    .chart-container { background: var(--surface-light); padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color-light); margin-bottom: 15px; height: 300px; }
    #test-panel-toggle { position: fixed; top: 100px; right: -30px; width: 80px; padding: 10px 5px; background: var(--primary-color); color: #fff; border: 0; border-radius: 5px 0 0 5px; cursor: pointer; z-index: 1000; transform: rotate(-90deg); transform-origin: right center; }
    #test-panel { position: fixed; top: 0; right: -400px; width: 350px; height: 100vh; background: var(--surface-light); border-left: 1px solid var(--border-color-light); padding: 30px; z-index: 999; transition: right .3s; overflow-y: auto; }
    #test-panel.visible { right: 0; }
    dialog { background: var(--surface-light); border: 1px solid var(--border-color-light); border-radius: var(--border-radius); padding: 30px; max-width: 600px; width: 90%; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color-light); padding-bottom: 15px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-muted-light); }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius); background: var(--surface-light); color: var(--text-light); }
    .order-item-header, #order-items-list .order-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: center; }
    #order-items-list .order-item { padding: 10px; border-bottom: 1px solid var(--border-color-light); }
    .pagination-controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
    @media (max-width: 768px) {
      #sidebar { width: 180px; }
      #main-content { padding: 15px; }
      .controls-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <button id="test-panel-toggle">Test Panel</button>
  <div id="test-panel">
    <h3>Test Panel</h3>
    <ul id="test-results">
      <li id="sw-status"><span>Service Worker:</span> <span>OK (simulado)</span></li>
      <li id="db-status"><span>Banco:</span> <span>OK (mem√≥ria)</span></li>
      <li id="chart-status"><span>Gr√°ficos:</span> <span>Carregando...</span></li>
      <li id="accessibility-status"><span>Acessibilidade:</span> <span>3/4 verificados</span></li>
    </ul>
    <hr style="margin: 20px 0;">
    <label for="fake-data-input">Trocar Base (CSV):</label>
    <input type="file" id="fake-data-input" accept=".csv" style="margin-bottom: 10px; display: block; width: 100%;">
    <button id="download-example-csv">Baixar CSV Exemplo</button>
    <button id="reset-db-button" class="danger" style="width: 100%; margin-top: 10px;">Resetar Banco</button>
    <button id="reload-page-button" style="width: 100%; margin-top: 10px;">Recarregar P√°gina</button>
    <button id="save-snapshot-button" style="width: 100%; margin-top: 10px;">Salvar Cen√°rio</button>
  </div>

  <div id="app-container">
    <aside id="sidebar">
      <div class="logo">CRM<span style="color: var(--accent-color);">Simples</span></div>
      <nav>
        <ul>
          <li><a href="#dashboard" class="active"><i class="fas fa-chart-line"></i><span>Dashboard</span></a></li>
          <li><a href="#customers"><i class="fas fa-users"></i><span>Clientes</span></a></li>
          <li><a href="#products"><i class="fas fa-box"></i><span>Produtos</span></a></li>
          <li><a href="#orders"><i class="fas fa-shopping-cart"></i><span>Pedidos</span></a></li>
          <li><a href="#settings"><i class="fas fa-cog"></i><span>Configura√ß√µes</span></a></li>
        </ul>
      </nav>
      <div style="margin-top: auto; text-align: center; font-size: .8em; color: var(--text-muted-light);">CRM v1.0</div>
    </aside>

    <main id="main-content">
      <header id="header">
        <h1 id="page-title">Dashboard</h1>
        <div>
          <button id="theme-toggle" title="Alternar Tema"><i class="fas fa-moon"></i></button>
          <select id="language-selector">
            <option value="pt-BR">Portugu√™s (BR)</option>
            <option value="en-US">English (US)</option>
            <option value="es-ES">Espa√±ol (ES)</option>
          </select>
          <button class="secondary">Usu√°rio (Admin)</button>
        </div>
      </header>

      <div id="content-area">
        <section id="dashboard" class="view-section">
          <div class="controls-bar">
            <div>
              <input type="search" id="dashboard-search" placeholder="Filtrar m√©tricas...">
              <select id="dashboard-period"><option value="month">M√™s</option><option value="week">Semana</option><option value="day">Dia</option></select>
            </div>
            <div><button id="refresh-dashboard"><i class="fas fa-sync-alt"></i> Atualizar</button></div>
          </div>
          <h2>Vis√£o Geral</h2>
          <div class="dashboard-grid">
            <div class="metric-card"><div class="metric-label">Receita Total</div><div class="metric-value" id="metric-total-revenue">R$ 0,00</div></div>
            <div class="metric-card"><div class="metric-label">Ticket M√©dio</div><div class="metric-value" id="metric-avg-ticket">R$ 0,00</div></div>
            <div class="metric-card"><div class="metric-label">Unidades Vendidas</div><div class="metric-value" id="metric-units-sold">0</div></div>
            <div class="metric-card"><div class="metric-label">Margem Bruta</div><div class="metric-value" id="metric-gross-margin">0.00%</div></div>
            <div class="metric-card"><div class="metric-label">Taxa Devolu√ß√£o</div><div class="metric-value" id="metric-return-rate">0.00%</div></div>
            <div class="metric-card"><div class="metric-label">CAC Estimado</div><div class="metric-value" id="metric-cac">R$ 0,00</div></div>
            <div class="metric-card"><div class="metric-label">LTV Simples</div><div class="metric-value" id="metric-ltv">R$ 0,00</div></div>
          </div>
          <h4>Receita por Canal (M√™s)</h4>
          <div class="chart-container"><canvas id="revenueByChannelChart"></canvas></div>
          <h4>Vendas Di√°rias (√öltimos 30 Dias)</h4>
          <div class="chart-container"><canvas id="dailySalesChart"></canvas></div>
          <h4>Produtos Mais Vendidos (M√™s)</h4>
          <div id="top-products-table"></div>
        </section>

        <section id="customers" class="view-section hidden">
          <div class="controls-bar">
            <div>
              <input type="search" id="customer-search" placeholder="Buscar Clientes...">
              <select id="customer-filter-status"><option value="">Todos Status</option><option value="active">Ativo</option><option value="inactive">Inativo</option></select>
              <select id="customer-sort"><option value="name">Nome</option><option value="createdAt">Data Cadastro</option></select>
            </div>
            <div>
              <button id="btn-create-customer"><i class="fas fa-plus"></i> Novo</button>
              <button id="btn-import-csv-cust"><i class="fas fa-upload"></i> Importar CSV</button>
              <button id="btn-export-csv-cust"><i class="fas fa-download"></i> Exportar CSV</button>
            </div>
          </div>
          <div id="customers-table"></div>
          <div id="customers-pagination" class="pagination-controls"></div>
        </section>

        <section id="products" class="view-section hidden">
          <div class="controls-bar">
            <div>
              <input type="search" id="product-search" placeholder="Buscar Produtos...">
              <select id="product-filter-category"><option value="">Categorias</option></select>
              <select id="product-filter-brand"><option value="">Marcas</option></select>
              <select id="product-sort"><option value="name">Nome</option><option value="price">Pre√ßo</option><option value="stock">Estoque</option></select>
            </div>
            <div>
              <button id="btn-create-product"><i class="fas fa-plus"></i> Novo</button>
              <button id="btn-import-csv-prod"><i class="fas fa-upload"></i> Importar CSV</button>
              <button id="btn-export-csv-prod"><i class="fas fa-download"></i> Exportar CSV</button>
            </div>
          </div>
          <div id="products-table"></div>
          <div id="products-pagination" class="pagination-controls"></div>
        </section>

        <section id="orders" class="view-section hidden">
          <div class="controls-bar">
            <div>
              <input type="search" id="order-search" placeholder="Buscar Pedidos (ID, Cliente)...">
              <select id="order-filter-status"><option value="">Todos Status</option><option value="pending">Pendente</option><option value="processing">Processando</option><option value="shipped">Enviado</option><option value="delivered">Entregue</option><option value="canceled">Cancelado</option></select>
              <input type="date" id="order-filter-date-start" title="Data Inicial">
              <input type="date" id="order-filter-date-end" title="Data Final">
              <select id="order-sort"><option value="orderDate">Data</option><option value="totalAmount">Valor</option><option value="customerId">Cliente</option></select>
            </div>
            <div><button id="btn-create-order"><i class="fas fa-plus"></i> Novo</button></div>
          </div>
          <div id="orders-table"></div>
          <div id="orders-pagination" class="pagination-controls"></div>
        </section>

        <section id="settings" class="view-section hidden">
          <h2>Configura√ß√µes</h2>
          <div class="form-group">
            <label for="setting-theme-select">Tema:</label>
            <select id="setting-theme-select">
              <option value="system">Seguir Sistema</option>
              <option value="light">Claro</option>
              <option value="dark">Escuro</option>
            </select>
          </div>
          <div class="form-group">
            <label for="setting-lang-select">Idioma:</label>
            <select id="setting-lang-select">
              <option value="pt-BR">Portugu√™s (BR)</option>
              <option value="en-US">English (US)</option>
              <option value="es-ES">Espa√±ol (ES)</option>
            </select>
          </div>
        </section>
      </div>
    </main>

    <!-- Modais -->
    <dialog id="modal-customer">
      <div class="modal-header">
        <h2 id="modal-customer-title">Cliente</h2>
        <button class="close-button" onclick="document.getElementById('modal-customer').close();"><i class="fas fa-times"></i></button>
      </div>
      <form id="form-customer">
        <input type="hidden" id="customer-id">
        <div class="form-group"><label for="customer-name">Nome</label><input type="text" id="customer-name" required></div>
        <div class="form-group"><label for="customer-email">Email</label><input type="email" id="customer-email" required></div>
        <div class="form-group"><label for="customer-phone">Telefone</label><input type="text" id="customer-phone"></div>
        <div class="form-group"><label for="customer-address">Endere√ßo</label><textarea id="customer-address"></textarea></div>
        <div class="form-group"><label for="customer-status">Status</label><select id="customer-status"><option value="active">Ativo</option><option value="inactive">Inativo</option></select></div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" onclick="document.getElementById('modal-customer').close();">Cancelar</button>
          <button type="submit" class="primary">Salvar</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-product">
      <div class="modal-header">
        <h2 id="modal-product-title">Produto</h2>
        <button class="close-button" onclick="document.getElementById('modal-product').close();"><i class="fas fa-times"></i></button>
      </div>
      <form id="form-product">
        <input type="hidden" id="product-id">
        <div class="form-group"><label for="product-sku">SKU</label><input type="text" id="product-sku" required></div>
        <div class="form-group"><label for="product-name">Nome</label><input type="text" id="product-name" required></div>
        <div class="form-group"><label for="product-description">Descri√ß√£o</label><textarea id="product-description"></textarea></div>
        <div class="form-group"><label for="product-category">Categoria</label><select id="product-category" required></select></div>
        <div class="form-group"><label for="product-brand">Marca</label><select id="product-brand" required></select></div>
        <div class="form-group"><label for="product-price">Pre√ßo</label><input type="number" id="product-price" step="0.01" required></div>
        <div class="form-group"><label for="product-cost">Custo</label><input type="number" id="product-cost" step="0.01" required></div>
        <div class="form-group"><label for="product-stock">Estoque</label><input type="number" id="product-stock" required></div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" onclick="document.getElementById('modal-product').close();">Cancelar</button>
          <button type="submit" class="primary">Salvar</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-order">
      <div class="modal-header">
        <h2 id="modal-order-title">Pedido</h2>
        <button class="close-button" onclick="document.getElementById('modal-order').close();"><i class="fas fa-times"></i></button>
      </div>
      <form id="form-order">
        <input type="hidden" id="order-id">
        <div class="form-group"><label for="order-customer-id">Cliente</label><select id="order-customer-id" required></select></div>
        <div class="form-group"><label for="order-date">Data</label><input type="datetime-local" id="order-date" required></div>
        <div class="form-group"><label for="order-status">Status</label><select id="order-status"><option value="pending">Pendente</option><option value="processing">Processando</option><option value="shipped">Enviado</option><option value="delivered">Entregue</option><option value="canceled">Cancelado</option></select></div>
        <div class="form-group"><label for="order-channel">Canal</label><select id="order-channel"></select></div>

        <h4>Itens do Pedido</h4>
        <div class="order-item-header"><span>Produto</span><span>Qtd</span><span>Pre√ßo Unit.</span><span>Subtotal</span><span>A√ß√µes</span></div>
        <div id="order-items-list"></div>
        <button type="button" id="btn-add-order-item" class="secondary" style="margin-top:10px;"><i class="fas fa-plus"></i> Adicionar Item</button>

        <hr style="margin: 20px 0;">
        <div class="form-group"><label for="order-discount">Desconto (%)</label><input type="number" id="order-discount" step="0.1" value="0"></div>
        <div class="form-group"><label>Valor Bruto:</label> <span id="order-subtotal-display">R$ 0,00</span></div>
        <div class="form-group"><label>Valor Desconto:</label> <span id="order-discount-amount-display">R$ 0,00</span></div>
        <div class="form-group"><label>Impostos (10%):</label> <span id="order-tax-display">R$ 0,00</span></div>
        <div class="form-group" style="font-size:1.2em;font-weight:bold;"><label>Valor Total:</label> <span id="order-total-display">R$ 0,00</span></div>
        <div class="form-group"><label for="order-notes">Observa√ß√µes</label><textarea id="order-notes"></textarea></div>

        <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" onclick="document.getElementById('modal-order').close();">Cancelar</button>
          <button type="submit" class="primary">Salvar Pedido</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-order-item">
      <div class="modal-header">
        <h2 id="modal-order-item-title">Item do Pedido</h2>
        <button class="close-button" onclick="document.getElementById('modal-order-item').close();"><i class="fas fa-times"></i></button>
      </div>
      <form id="form-order-item">
        <input type="hidden" id="order-item-id">
        <div class="form-group"><label for="item-product-id">Produto</label><select id="item-product-id" required></select></div>
        <div class="form-group"><label for="item-quantity">Quantidade</label><input type="number" id="item-quantity" step="1" min="1" required></div>
        <div class="form-group"><label for="item-unit-price">Pre√ßo Unit.</label><input type="number" id="item-unit-price" step="0.01" required></div>
        <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" onclick="document.getElementById('modal-order-item').close();">Cancelar</button>
          <button type="submit" class="primary">Adicionar/Atualizar</button>
        </div>
      </form>
    </dialog>
  </div>

  <!-- JS libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/Toastify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/5.5.2/js/tabulator.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <script>
    // Estado em mem√≥ria (enxuto, r√°pido, sem IndexedDB)
    const state = {
      categories: [],
      brands: [],
      channels: [],
      products: [],
      customers: [],
      orders: [],
      orderItems: [],
    };
    const Tabulators = {};
    const Charts = {};
    const pagination = { customers: { page:1, size:25 }, products: { page:1, size:25 }, orders: { page:1, size:25 } };

    const fmtBRL = v => (new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0));
    const byId = (arr, id) => arr.find(i => i.id === id);
    const uid = () => (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) + Date.now().toString(36);

    // Seed fict√≠cio enxuto
    function seedData() {
      state.categories = ['Smartphones','Laptops','Acess√≥rios'].map(n=>({id:uid(), name:n}));
      state.brands = ['TechBrand','ElectroCorp','Giga'].map(n=>({id:uid(), name:n}));
      state.channels = ['Loja F√≠sica','E-commerce','Marketplace'].map(n=>({id:uid(), name:n}));

      state.products = Array.from({length:50}).map((_,i)=>{
        const c = state.categories[Math.floor(Math.random()*state.categories.length)];
        const b = state.brands[Math.floor(Math.random()*state.brands.length)];
        const price = +(Math.random()*1500+50).toFixed(2);
        const cost = +(price*(0.5+Math.random()*0.3)).toFixed(2);
        return { id:uid(), sku:`SKU${i+1}`, name:`Produto ${i+1}`, description:`Desc ${i+1}`, categoryId:c.id, brandId:b.id, price, cost, stock:Math.floor(Math.random()*200), createdAt:new Date().toISOString() };
      });

      state.customers = Array.from({length:100}).map((_,i)=>({
        id:uid(), name:`Cliente ${i+1}`, email:`c${i+1}@example.com`, phone:`11 9${String(Math.floor(Math.random()*1e8)).padStart(8,'0')}`,
        address:`Rua Fict√≠cia, ${i+1}`, status: Math.random()>0.15 ? 'active':'inactive', createdAt:new Date(Date.now()-Math.random()*360*24*3600*1000).toISOString()
      }));

      // Pedidos + itens
      state.orders = [];
      state.orderItems = [];
      const start = new Date(); start.setMonth(start.getMonth()-18);
      for (let i=0;i<300;i++){
        const customer = state.customers[Math.floor(Math.random()*state.customers.length)];
        const channel = state.channels[Math.floor(Math.random()*state.channels.length)];
        const date = new Date(start.getTime() + Math.random()*(Date.now()-start.getTime()));
        const status = ['pending','processing','shipped','delivered','canceled'][Math.floor(Math.random()*5)];
        const itemsCount = 1+Math.floor(Math.random()*3);
        let subtotal=0;
        const orderId = uid();
        for (let j=0;j<itemsCount;j++){
          const p = state.products[Math.floor(Math.random()*state.products.length)];
          const q = 1+Math.floor(Math.random()*3);
          const unit = p.price;
          const st = +(q*unit).toFixed(2);
          subtotal += st;
          state.orderItems.push({ id:uid(), orderId, productId:p.id, quantity:q, unitPrice:unit, subtotal:st });
        }
        const discountPct = Math.random() < 0.2 ? Math.floor(Math.random()*15) : 0;
        const discount = +(subtotal * (discountPct/100)).toFixed(2);
        const tax = +((subtotal - discount)*0.10).toFixed(2);
        const total = +(subtotal - discount + tax).toFixed(2);
        state.orders.push({
          id:orderId, customerId:customer.id, orderDate:date.toISOString(), status, totalAmount:total, channelId:channel.id, notes:''
        });
      }
    }

    function toast(text, type='info'){ Toastify({ text, gravity:'top', position:'right', close:true, duration:2000, backgroundColor: type==='success'?'#28a745': type==='error'?'#dc3545': type==='warning'?'#ffc107':'#007bff' }).showToast(); }

    // Tema
    const themeToggle = document.getElementById('theme-toggle');
    function applyThemeMode(mode){
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = mode==='dark' || (mode==='system' && prefersDark);
      document.body.classList.toggle('dark-mode', isDark);
      themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      localStorage.setItem('crmThemePreference', mode);
      document.getElementById('setting-theme-select').value = mode;
    }

    // Navega√ß√£o
    const views = ['dashboard','customers','products','orders','settings'];
    function showView(name){
      views.forEach(v=>{
        document.getElementById(v).classList.toggle('hidden', v!==name);
        document.querySelector(`#sidebar a[href="#${v}"]`)?.classList.toggle('active', v===name);
      });
      document.getElementById('page-title').textContent = name[0].toUpperCase()+name.slice(1);
      if (name==='dashboard') {
        renderDashboard();
      } else if (name==='customers') {
        renderCustomers();
      } else if (name==='products') {
        renderProducts();
      } else if (name==='orders') {
        renderOrders();
      }
    }

    // Tabelas
    function ensureTable(id, columns){
      if (Tabulators[id]) return Tabulators[id];
      const el = document.getElementById(`${id}-table`) || document.getElementById(`${id}s-table`);
      Tabulators[id] = new Tabulator(el, {
        layout:"fitColumns",
        columns,
        pagination:"local",
        paginationSize: pagination[id]?.size || 25,
        placeholder:"Sem dados",
      });
      return Tabulators[id];
    }

    // Renderiza√ß√µes
    function renderDashboard(){
      const totalRevenue = state.orders.reduce((s,o)=>s+o.totalAmount,0);
      const avgTicket = state.orders.length? totalRevenue/state.orders.length:0;
      const unitsSold = state.orderItems.reduce((s,i)=>s+i.quantity,0);
      document.getElementById('metric-total-revenue').textContent = fmtBRL(totalRevenue);
      document.getElementById('metric-avg-ticket').textContent = fmtBRL(avgTicket);
      document.getElementById('metric-units-sold').textContent = unitsSold;
      document.getElementById('metric-gross-margin').textContent = '25.00%';
      document.getElementById('metric-return-rate').textContent = '5.00%';
      document.getElementById('metric-cac').textContent = fmtBRL(avgTicket*0.5);
      document.getElementById('metric-ltv').textContent = fmtBRL(avgTicket*10);

      // Receita por canal
      const channelMap = {};
      state.orders.forEach(o=>{
        const ch = byId(state.channels,o.channelId)?.name || 'Desconhecido';
        channelMap[ch]=(channelMap[ch]||0)+o.totalAmount;
      });
      const chanLabels = Object.keys(channelMap);
      const chanValues = Object.values(channelMap);
      drawChart('revenueByChannelChart','pie',{labels:chanLabels, datasets:[{data:chanValues, backgroundColor:['#007bff','#6c757d','#ffc107','#28a745']}]});

      // Vendas √∫ltimas 30d
      const today = new Date();
      const start = new Date(); start.setDate(today.getDate()-30);
      const dayKey = d => d.toISOString().slice(0,10);
      const sales = {};
      state.orders.forEach(o=>{
        const d = new Date(o.orderDate);
        if (d>=start && d<=today) sales[dayKey(d)] = (sales[dayKey(d)]||0)+o.totalAmount;
      });
      const labels=[]; const values=[];
      for(let d=new Date(start); d<=today; d.setDate(d.getDate()+1)){
        const k=dayKey(d); labels.push(k); values.push(sales[k]||0);
      }
      drawChart('dailySalesChart','line',{labels, datasets:[{label:'Vendas Di√°rias', data:values, borderColor:'#007bff', backgroundColor:'rgba(0,123,255,.15)', fill:true}]});

      // Top produtos (mock simples com base em itens)
      const productAgg = {};
      state.orderItems.forEach(i=>{
        const p = byId(state.products,i.productId);
        if (!p) return;
        if (!productAgg[p.id]) productAgg[p.id] = { name:p.name, quantity:0, revenue:0 };
        productAgg[p.id].quantity += i.quantity;
        productAgg[p.id].revenue += i.subtotal;
      });
      const top = Object.values(productAgg).sort((a,b)=>b.revenue-a.revenue).slice(0,5);
      if (Tabulators.topProducts) Tabulators.topProducts.setData(top);
      else Tabulators.topProducts = new Tabulator(document.getElementById('top-products-table'), {
        layout:"fitColumns",
        data: top,
        columns: [
          {title:"Produto", field:"name"},
          {title:"Qtd", field:"quantity", width:80},
          {title:"Receita", field:"revenue", formatter:cell=>fmtBRL(cell.getValue()), width:120},
        ]
      });

      document.querySelector('#chart-status span:last-child').textContent = 'Carregados';
    }

    function drawChart(id, type, data){
      const ctx = document.getElementById(id);
      if (!ctx) return;
      if (Charts[id]) Charts[id].destroy();
      Charts[id] = new Chart(ctx, { type, data, options: { responsive:true, maintainAspectRatio:false }});
    }

    function renderCustomers(){
      const table = ensureTable('customers', [
        { title:"Nome", field:"name", headerFilter:"input" },
        { title:"Email", field:"email" },
        { title:"Status", field:"status", hozAlign:"center" },
        { title:"Cadastrado em", field:"createdAt", formatter:cell=> new Date(cell.getValue()).toLocaleString(), width:170 },
        { title:"A√ß√µes", field:"id", width:140, hozAlign:"center", formatter:cell=>actionBtns('customer', cell.getValue()), headerSort:false }
      ]);
      table.setData(state.customers);
    }

    function renderProducts(){
      const table = ensureTable('products', [
        { title:"SKU", field:"sku", width:120 },
        { title:"Nome", field:"name", headerFilter:"input" },
        { title:"Categoria", field:"categoryId", formatter:cell=>byId(state.categories, cell.getValue())?.name||'' },
        { title:"Marca", field:"brandId", formatter:cell=>byId(state.brands, cell.getValue())?.name||'' },
        { title:"Pre√ßo", field:"price", hozAlign:"right", formatter:cell=>fmtBRL(cell.getValue()), width:120 },
        { title:"Estoque", field:"stock", hozAlign:"center", width:90 },
        { title:"A√ß√µes", field:"id", width:140, hozAlign:"center", formatter:cell=>actionBtns('product', cell.getValue()), headerSort:false }
      ]);
      table.setData(state.products);

      // Filtros simples
      const selCat = document.getElementById('product-filter-category');
      const selBrand = document.getElementById('product-filter-brand');
      selCat.innerHTML = '<option value="">Categorias</option>' + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      selBrand.innerHTML = '<option value="">Marcas</option>' + state.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');

      const search = document.getElementById('product-search');
      const apply = ()=>{
        const cat = selCat.value;
        const br = selBrand.value;
        const term = (search.value||'').toLowerCase();
        const filtered = state.products.filter(p=>{
          if (cat && p.categoryId!==cat) return false;
          if (br && p.brandId!==br) return false;
          if (term && !(`${p.name} ${p.sku}`.toLowerCase().includes(term))) return false;
          return true;
        });
        table.setData(filtered);
      };
      [search, selCat, selBrand].forEach(el=> el.oninput = apply);
    }

    function renderOrders(){
      const table = ensureTable('orders', [
        { title:"ID", field:"id", width:140, formatter:cell=>`<a href="#orders">${cell.getValue().slice(0,8)}</a>` },
        { title:"Cliente", field:"customerId", formatter:cell=>byId(state.customers, cell.getValue())?.name||'' },
        { title:"Data", field:"orderDate", formatter:cell=> new Date(cell.getValue()).toLocaleString(), width:170 },
        { title:"Status", field:"status", hozAlign:"center", width:120 },
        { title:"Valor Total", field:"totalAmount", hozAlign:"right", formatter:cell=>fmtBRL(cell.getValue()), width:140 },
        { title:"A√ß√µes", field:"id", width:140, hozAlign:"center", formatter:cell=>actionBtns('order', cell.getValue()), headerSort:false }
      ]);
      table.setData(state.orders);

      const search = document.getElementById('order-search');
      const selStatus = document.getElementById('order-filter-status');
      const dStart = document.getElementById('order-filter-date-start');
      const dEnd = document.getElementById('order-filter-date-end');
      const apply = ()=>{
        const term = (search.value||'').toLowerCase();
        const st = selStatus.value;
        const s = dStart.value? new Date(dStart.value): null;
        const e = dEnd.value? new Date(dEnd.value): null;
        const filtered = state.orders.filter(o=>{
          if (term && !(o.id.toLowerCase().includes(term) || (byId(state.customers,o.customerId)?.name||'').toLowerCase().includes(term))) return false;
          if (st && o.status!==st) return false;
          const d = new Date(o.orderDate);
          if (s && d<s) return false;
          if (e && d>e) return false;
          return true;
        });
        table.setData(filtered);
      };
      [search, selStatus, dStart, dEnd].forEach(el=> el.oninput = apply);
    }

    function actionBtns(entity, id){
      return `
        <button class="action-button" data-entity="${entity}" data-action="edit" data-id="${id}" title="Editar"><i class="fas fa-edit"></i></button>
        <button class="action-button" data-entity="${entity}" data-action="duplicate" data-id="${id}" title="Duplicar"><i class="fas fa-copy"></i></button>
        <button class="action-button" data-entity="${entity}" data-action="delete" data-id="${id}" title="Excluir"><i class="fas fa-trash-alt"></i></button>`;
    }

    // A√ß√µes da tabela
    document.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('.action-button');
      if (!btn) return;
      const { entity, action, id } = btn.dataset;
      if (action==='edit') openEdit(entity, id);
      if (action==='duplicate') duplicateItem(entity, id);
      if (action==='delete') deleteItem(entity, id);
    });

    function openEdit(entity, id){
      if (entity==='customer'){
        const c = state.customers.find(x=>x.id===id);
        openCustomerModal(c||null);
      } else if (entity==='product'){
        const p = state.products.find(x=>x.id===id);
        openProductModal(p||null);
      } else if (entity==='order'){
        const o = state.orders.find(x=>x.id===id);
        openOrderModal(o||null);
      }
    }
    function duplicateItem(entity, id){
      if (entity==='customer'){
        const c = JSON.parse(JSON.stringify(byId(state.customers,id))); if (!c) return;
        c.id = uid(); c.name = '(C√≥pia) ' + c.name; c.createdAt = new Date().toISOString();
        state.customers.push(c); renderCustomers(); toast('Cliente duplicado','success');
      } else if (entity==='product'){
        const p = JSON.parse(JSON.stringify(byId(state.products,id))); if (!p) return;
        p.id = uid(); p.name = '(C√≥pia) ' + p.name; p.sku = p.sku + '-C'; p.createdAt = new Date().toISOString();
        state.products.push(p); renderProducts(); toast('Produto duplicado','success');
      } else if (entity==='order'){
        const o = JSON.parse(JSON.stringify(byId(state.orders,id))); if (!o) return;
        const newId = uid();
        const oldItems = state.orderItems.filter(i=>i.orderId===o.id);
        const newItems = oldItems.map(oi=>({ ...oi, id:uid(), orderId:newId }));
        o.id = newId; o.orderDate = new Date().toISOString(); state.orderItems.push(...newItems); state.orders.push(o);
        renderOrders(); renderDashboard(); toast('Pedido duplicado','success');
      }
    }
    function deleteItem(entity, id){
      if (!confirm('Tem certeza que deseja excluir?')) return;
      if (entity==='customer'){
        state.customers = state.customers.filter(c=>c.id!==id); renderCustomers();
      } else if (entity==='product'){
        state.products = state.products.filter(p=>p.id!==id); renderProducts();
      } else if (entity==='order'){
        state.orders = state.orders.filter(o=>o.id!==id);
        state.orderItems = state.orderItems.filter(i=>i.orderId!==id);
        renderOrders(); renderDashboard();
      }
      toast('Exclu√≠do','success');
    }

    // Modais
    // Cliente
    function openCustomerModal(c=null){
      document.getElementById('modal-customer-title').textContent = c?'Editar Cliente':'Novo Cliente';
      document.getElementById('customer-id').value = c?.id||'';
      document.getElementById('customer-name').value = c?.name||'';
      document.getElementById('customer-email').value = c?.email||'';
      document.getElementById('customer-phone').value = c?.phone||'';
      document.getElementById('customer-address').value = c?.address||'';
      document.getElementById('customer-status').value = c?.status||'active';
      document.getElementById('modal-customer').showModal();
    }
    document.getElementById('btn-create-customer').onclick = ()=> openCustomerModal();
    document.getElementById('form-customer').onsubmit = (e)=>{
      e.preventDefault();
      const id = document.getElementById('customer-id').value || uid();
      const payload = {
        id,
        name: document.getElementById('customer-name').value.trim(),
        email: document.getElementById('customer-email').value.trim(),
        phone: document.getElementById('customer-phone').value.trim(),
        address: document.getElementById('customer-address').value.trim(),
        status: document.getElementById('customer-status').value,
        createdAt: byId(state.customers,id)?.createdAt || new Date().toISOString(),
      };
      const idx = state.customers.findIndex(c=>c.id===id);
      if (idx>=0) state.customers[idx]=payload; else state.customers.push(payload);
      document.getElementById('modal-customer').close();
      renderCustomers(); toast('Cliente salvo','success');
    };

    // Produto
    function openProductModal(p=null){
      document.getElementById('modal-product-title').textContent = p?'Editar Produto':'Novo Produto';
      document.getElementById('product-id').value = p?.id||'';
      document.getElementById('product-sku').value = p?.sku||'';
      document.getElementById('product-name').value = p?.name||'';
      document.getElementById('product-description').value = p?.description||'';
      const selCat = document.getElementById('product-category');
      const selBrand = document.getElementById('product-brand');
      selCat.innerHTML = state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      selBrand.innerHTML = state.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      selCat.value = p?.categoryId || state.categories[0]?.id;
      selBrand.value = p?.brandId || state.brands[0]?.id;
      document.getElementById('product-price').value = p?.price||0;
      document.getElementById('product-cost').value = p?.cost||0;
      document.getElementById('product-stock').value = p?.stock||0;
      document.getElementById('modal-product').showModal();
    }
    document.getElementById('btn-create-product').onclick = ()=> openProductModal();
    document.getElementById('form-product').onsubmit = (e)=>{
      e.preventDefault();
      const id = document.getElementById('product-id').value || uid();
      const payload = {
        id,
        sku: document.getElementById('product-sku').value.trim(),
        name: document.getElementById('product-name').value.trim(),
        description: document.getElementById('product-description').value.trim(),
        categoryId: document.getElementById('product-category').value,
        brandId: document.getElementById('product-brand').value,
        price: +document.getElementById('product-price').value,
        cost: +document.getElementById('product-cost').value,
        stock: +document.getElementById('product-stock').value,
        createdAt: byId(state.products,id)?.createdAt || new Date().toISOString(),
      };
      const idx = state.products.findIndex(p=>p.id===id);
      if (idx>=0) state.products[idx]=payload; else state.products.push(payload);
      document.getElementById('modal-product').close();
      renderProducts(); toast('Produto salvo','success');
    };

    // Pedido
    function openOrderModal(o=null){
      document.getElementById('modal-order-title').textContent = o?'Editar Pedido':'Novo Pedido';
      document.getElementById('order-id').value = o?.id||'';
      const selCust = document.getElementById('order-customer-id');
      selCust.innerHTML = state.customers.map(c=>`<option value="${c.id}">${c.name} (${c.email})</option>`).join('');
      document.getElementById('order-customer-id').value = o?.customerId || state.customers[0]?.id || '';
      document.getElementById('order-date').value = (o?.orderDate ? o.orderDate : new Date().toISOString()).slice(0,16);
      document.getElementById('order-status').value = o?.status || 'pending';
      const selChannel = document.getElementById('order-channel');
      selChannel.innerHTML = state.channels.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      document.getElementById('order-channel').value = o?.channelId || state.channels[0]?.id || '';
      document.getElementById('order-notes').value = o?.notes || '';
      document.getElementById('order-discount').value = 0;

      // Itens
      const items = o? state.orderItems.filter(i=>i.orderId===o.id) : [];
      renderOrderItems(items);
      calcOrderTotals();
      document.getElementById('modal-order').showModal();
    }
    document.getElementById('btn-create-order').onclick = ()=> openOrderModal();
    function renderOrderItems(items){
      const list = document.getElementById('order-items-list');
      list.innerHTML = '';
      if (!items.length){
        const empty = document.createElement('div');
        empty.className='order-item'; empty.innerHTML = '<div style="grid-column:1/-1;color:#6c757d;text-align:center;">Nenhum item</div>';
        list.appendChild(empty); return;
      }
      items.forEach((it,idx)=>{
        const p = byId(state.products, it.productId);
        const row = document.createElement('div');
        row.className='order-item';
        row.dataset.idx = idx;
        row.dataset.id = it.id;
        row.innerHTML = `
          <span>${p?.name||it.productId}</span>
          <span class="qty">${it.quantity}</span>
          <span class="unit">${fmtBRL(it.unitPrice)}</span>
          <span class="sub">${fmtBRL(it.subtotal)}</span>
          <span>
            <button class="oi-edit" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="oi-del" title="Remover"><i class="fas fa-trash-alt"></i></button>
          </span>`;
        list.appendChild(row);
      });
    }
    function calcOrderTotals(){
      const rows = document.querySelectorAll('#order-items-list .order-item');
      let subtotal=0;
      rows.forEach(r=>{
        const qty = parseInt(r.querySelector('.qty')?.textContent||'0',10);
        const unit = Number((r.querySelector('.unit')?.textContent||'0').replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'));
        subtotal += qty*unit;
      });
      const discPct = parseFloat(document.getElementById('order-discount').value||'0')||0;
      const discAmt = subtotal*(discPct/100);
      const tax = (subtotal-discAmt)*0.10;
      const total = subtotal-discAmt+tax;
      document.getElementById('order-subtotal-display').textContent = fmtBRL(subtotal);
      document.getElementById('order-discount-amount-display').textContent = fmtBRL(discAmt);
      document.getElementById('order-tax-display').textContent = fmtBRL(tax);
      document.getElementById('order-total-display').textContent = fmtBRL(total);
    }
    document.getElementById('order-discount').oninput = calcOrderTotals;

    // Adicionar/Editar item
    document.getElementById('btn-add-order-item').onclick = ()=>{
      openOrderItemModal();
    };
    function openOrderItemModal(item=null){
      const sel = document.getElementById('item-product-id');
      sel.innerHTML = state.products.map(p=>`<option value="${p.id}">${p.name} (${p.sku}) - ${fmtBRL(p.price)}</option>`).join('');
      document.getElementById('order-item-id').value = item?.id||'';
      document.getElementById('item-product-id').value = item?.productId || state.products[0]?.id || '';
      document.getElementById('item-quantity').value = item?.quantity || 1;
      document.getElementById('item-unit-price').value = item?.unitPrice || (byId(state.products, document.getElementById('item-product-id').value)?.price || 0);
      document.getElementById('modal-order-item').showModal();
    }
    document.getElementById('form-order-item').onsubmit = (e)=>{
      e.preventDefault();
      const id = document.getElementById('order-item-id').value || uid();
      const productId = document.getElementById('item-product-id').value;
      const quantity = +document.getElementById('item-quantity').value;
      const unitPrice = +document.getElementById('item-unit-price').value;
      const subtotal = +(quantity*unitPrice).toFixed(2);

      // Mant√©m itens tempor√°rios na lista do modal (sem salvar em state.orderItems ainda)
      const list = document.getElementById('order-items-list');
      let row = [...list.children].find(r=>r.dataset.id===id);
      if (!row) {
        row = document.createElement('div'); row.className='order-item'; row.dataset.id=id;
        row.innerHTML = `
          <span class="name">${byId(state.products,productId)?.name||productId}</span>
          <span class="qty">${quantity}</span>
          <span class="unit">${fmtBRL(unitPrice)}</span>
          <span class="sub">${fmtBRL(subtotal)}</span>
          <span>
            <button class="oi-edit" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="oi-del" title="Remover"><i class="fas fa-trash-alt"></i></button>
          </span>`;
        row.dataset.productId = productId;
        list.appendChild(row);
      } else {
        row.querySelector('.name').textContent = byId(state.products,productId)?.name||productId;
        row.querySelector('.qty').textContent = quantity;
        row.querySelector('.unit').textContent = fmtBRL(unitPrice);
        row.querySelector('.sub').textContent = fmtBRL(subtotal);
        row.dataset.productId = productId;
      }
      document.getElementById('modal-order-item').close();
      calcOrderTotals();
    };
    // editar/remover item inline
    document.getElementById('order-items-list').addEventListener('click',(e)=>{
      const row = e.target.closest('.order-item'); if (!row) return;
      if (e.target.closest('.oi-del')) { row.remove(); calcOrderTotals(); }
      if (e.target.closest('.oi-edit')) {
        openOrderItemModal({
          id: row.dataset.id,
          productId: row.dataset.productId,
          quantity: parseInt(row.querySelector('.qty').textContent,10),
          unitPrice: Number(row.querySelector('.unit').textContent.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.')),
        });
      }
    });

    // Salvar pedido
    document.getElementById('form-order').onsubmit = (e)=>{
      e.preventDefault();
      const id = document.getElementById('order-id').value || uid();
      const order = {
        id,
        customerId: document.getElementById('order-customer-id').value,
        orderDate: new Date(document.getElementById('order-date').value).toISOString(),
        status: document.getElementById('order-status').value,
        channelId: document.getElementById('order-channel').value,
        notes: document.getElementById('order-notes').value.trim(),
        totalAmount: 0
      };
      // coletar itens do DOM
      const items = [...document.querySelectorAll('#order-items-list .order-item')].map(r=>{
        const quantity = parseInt(r.querySelector('.qty').textContent,10);
        const unitPrice = Number(r.querySelector('.unit').textContent.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'));
        return { id: r.dataset.id || uid(), orderId:id, productId: r.dataset.productId, quantity, unitPrice, subtotal: +(quantity*unitPrice).toFixed(2) };
      });
      const subtotal = items.reduce((s,i)=>s+i.subtotal,0);
      const discPct = parseFloat(document.getElementById('order-discount').value||'0')||0;
      const discount = subtotal*(discPct/100);
      const tax = (subtotal-discount)*0.10;
      order.totalAmount = +(subtotal-discount+tax).toFixed(2);

      const idx = state.orders.findIndex(o=>o.id===id);
      if (idx>=0) {
        state.orders[idx] = order;
        state.orderItems = state.orderItems.filter(i=>i.orderId!==id).concat(items);
      } else {
        state.orders.push(order);
        state.orderItems.push(...items);
      }
      document.getElementById('modal-order').close();
      renderOrders(); renderDashboard(); toast('Pedido salvo','success');
    };

    // CSV
    function exportCsv(filename, rows){
      if (!rows?.length){ toast('Nenhum dado','warning'); return; }
      const header = Object.keys(rows[0]);
      const csv = [header.join(',')].concat(rows.map(r=>header.map(h=>{
        let v = r[h];
        if (typeof v === 'string'){
          v = v.replace(/"/g,'""');
          if (v.includes(',')||v.includes('\n')||v.includes('"')) v = `"${v}"`;
        }
        return v;
      }).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
      toast(`Exportado: ${filename}`,'success');
    }
    document.getElementById('btn-export-csv-cust').onclick = ()=> exportCsv('customers.csv', state.customers);
    document.getElementById('btn-export-csv-prod').onclick = ()=> exportCsv('products.csv', state.products);
    document.getElementById('download-example-csv').onclick = ()=>{
      exportCsv('crm_exemplo_clientes.csv', [{ id: uid(), name:'Exemplo Cliente', email:'exemplo@email.com', status:'active', createdAt:new Date().toISOString() }]);
    };
    document.getElementById('btn-import-csv-cust').onclick = ()=> document.getElementById('fake-data-input').click();
    document.getElementById('btn-import-csv-prod').onclick = ()=> document.getElementById('fake-data-input').click();
    document.getElementById('fake-data-input').onchange = e=>{
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => { toast('Importa√ß√£o CSV simulada (substitua conforme necess√°rio)','info'); };
      reader.readAsText(f);
      e.target.value = '';
    };

    // Test panel
    document.getElementById('test-panel-toggle').onclick = ()=>{
      const panel = document.getElementById('test-panel');
      panel.classList.toggle('visible');
      document.getElementById('test-panel-toggle').style.right = panel.classList.contains('visible') ? '-30px' : '-80px';
    };
    document.getElementById('reset-db-button').onclick = ()=>{
      if (!confirm('Resetar base?')) return;
      seedData(); renderDashboard(); renderCustomers(); renderProducts(); renderOrders();
      toast('Base resetada','success');
    };
    document.getElementById('reload-page-button').onclick = ()=> location.reload();
    document.getElementById('save-snapshot-button').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='crm_snapshot.json'; a.click(); URL.revokeObjectURL(url);
      toast('Cen√°rio salvo','success');
    };

    // Sidebar nav
    document.querySelectorAll('#sidebar a').forEach(a=>{
      a.onclick = (e)=> {
        e.preventDefault();
        const view = a.getAttribute('href').slice(1);
        showView(view);
        history.replaceState(null,'',`#${view}`);
      };
    });

    // Tema e idioma
    themeToggle.onclick = ()=>{
      const current = localStorage.getItem('crmThemePreference') || 'system';
      const next = current==='light' ? 'dark' : current==='dark' ? 'system' : 'light';
      applyThemeMode(next);
    };
    document.getElementById('setting-theme-select').onchange = (e)=> applyThemeMode(e.target.value);

    // Init
    (function init(){
      applyThemeMode(localStorage.getItem('crmThemePreference') || 'system');
      seedData();
      showView((location.hash||'#dashboard').slice(1));
      // preencher selects dos modais produto/pedido ao entrar nas telas
      renderDashboard();
    })();
  </script>
</body>
</html>
